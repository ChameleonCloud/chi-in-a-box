---
- set_fact:
    prometheus_services_list: "{{ prometheus_services | dict2items | map(attribute='value') | list }}"

- name: Pull Docker images.
  docker_image:
    name: "{{ item.image }}"
  loop: "{{ prometheus_services_list }}"
  loop_control:
    label: "{{ item.image | default('skipped') }}"
  when: inventory_hostname in groups[item.group] and
        item.image is defined

- name: Create config directories.
  file:
    path: "{{ item.config_dir }}"
    state: directory
  loop: "{{ prometheus_services_list }}"
  loop_control:
    label: "{{ item.config_dir | default('skipped') }}"
  when: inventory_hostname in groups[item.group] and
        item.config_dir is defined

- include_tasks: alertmanager.yml
  vars:
    service: "{{ prometheus_services['alertmanager'] }}"
  when: inventory_hostname in groups[service.group]

- include_tasks: mysql_exporter.yml
  vars:
    service: "{{ prometheus_services['mysql-exporter'] }}"
  when: inventory_hostname in groups[service.group]

- include_tasks: node_exporter.yml
  vars:
    service: "{{ prometheus_services['node-exporter'] }}"
  when: inventory_hostname in groups[service.group]

- include_tasks: openstack_exporter.yml
  vars:
    service: "{{ prometheus_services['openstack-exporter'] }}"
  when: inventory_hostname in groups[service.group]

- include_tasks: server.yml
  vars:
    service: "{{ prometheus_services['server'] }}"
  when: inventory_hostname in groups[service.group]

- name: Create Docker services.
  template:
    src: systemd.service.j2
    dest: "/usr/lib/systemd/system/{{ item.service_name }}.service"
  notify:
    - reload systemd daemon
  loop: "{{ prometheus_services_list }}"
  loop_control:
    label: "{{ item.service_name }}"
  when: inventory_hostname in groups[item.group] and
        (item.custom_service is not defined or (not item.custom_service | bool))

- name: Create custom services.
  template:
    src: "{{ item.service_name }}.service.j2"
    dest: "/usr/lib/systemd/system/{{ item.service_name }}.service"
  notify:
    - reload systemd daemon
  loop: "{{ prometheus_services_list }}"
  loop_control:
    label: "{{ item.service_name }}"
  when: inventory_hostname in groups[item.group] and
        item.custom_service is defined and
        (item.custom_service | bool)

- name: Enable services.
  systemd:
    service: "{{ item.service_name }}"
    state: started
    enabled: yes
  loop: "{{ prometheus_services_list }}"
  loop_control:
    label: "{{ item.service_name }}"
  when: inventory_hostname in groups[item.group]
