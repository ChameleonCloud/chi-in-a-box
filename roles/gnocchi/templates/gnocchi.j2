#!/bin/bash

export SWIFT_PREAUTHTOKEN="{{ gnocchi_backup_auth_token }}" && \
  export SWIFT_PREAUTHURL="{{ gnocchi_backup_swift_endpoint }}" && \
  duplicity full --archive-dir="{{ gnocchi_backup_archive_dir }}" \
  --name="{{ gnocchi_backup_name }}" \
  --file-prefix="{{ gnocchi_backup_file_prefix }}" \
  --volsize 1000 \
  --asynchronous-upload \
  --no-encryption \
  "{{ gnocchi_backup_origin_dir }}" \ 
  swift://"{{ gnocchi_backup_container }}" && \
  duplicity remove-older-than 3D \
  --force \
  --file-prefix="{{gnocchi_backup_file_prefix }}" \
  swift://"{{ gnocchi_backup_container }}" \
  2>&1 | /usr/bin/logger -t "{{ gnocchi_backup_log_key }}"
