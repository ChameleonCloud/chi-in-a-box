---
- hosts: docker_registry
  roles:
    - docker_registry
  tasks:
    - name: Set facts for gathering in frontend hosts.
      set_fact:
        docker_registry_hostname: "{{ docker_registry_hostname }}"
        docker_registry_port: "{{ docker_registry_port }}"
        docker_registry_auth_allow_push_projects: "{{ docker_registry_auth_allow_push_projects }}"
      tags:
        - configuration

- hosts: frontends
  tasks:
    - name: Configure virtual host for docker registry backend.
      block:
        - name: Gather facts from docker registry host.
          setup:
          delegate_to: "{{ groups.docker_registry[0] }}"
          delegate_facts: True
        - name: Precompute convenience facts needed for virtual host configuration.
          set_fact:
            docker_registry_hostname: "{{ hostvars[groups.docker_registry[0]].docker_registry_hostname }}"
            docker_registry_port: "{{ hostvars[groups.docker_registry[0]].docker_registry_port }}"
            docker_registry_auth_allow_push_projects: "{{ hostvars[groups.docker_registry[0]].docker_registry_auth_allow_push_projects }}"
            docker_registry_internal_address: "{{ groups.docker_registry[0] }}"
        - name: Configure virtual host.
          include_role:
            name: apache
            tasks_from: host
          vars:
            apache_server_name: "{{ docker_registry_hostname }}"
            apache_server_conf: |
              ProxyPass        /v2 http://{{ docker_registry_internal_address }}:{{ docker_registry_port }}/v2
              ProxyPassReverse /v2 http://{{ docker_registry_internal_address }}:{{ docker_registry_port }}/v2

              <Location /v2>
                Order deny,allow
                Allow from all

                AuthType Basic
                AuthName "Registry Authentication"
                AuthBasicProvider external
                AuthExternal keystone-user
                GroupExternal keystone-project

                # Read access to all authentified users and internal nodes
                <Limit GET HEAD>
                  <RequireAny>
                    Require valid-user
                    {% for addr in groups['all'] | map('extract', hostvars, 'ansible_host') | list %}
                    Require ip {{ addr }}
                    {% endfor %}
                  </RequireAny>
                </Limit>

                # TODO: Write access to operators by group membership
                <Limit POST PUT DELETE PATCH>
                  Require user jason_a
                </Limit>
              </Location>
      tags:
        - configuration
