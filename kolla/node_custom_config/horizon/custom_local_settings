from os import environ

from django.utils.translation import ugettext_lazy as _
from openstack_dashboard.settings import HORIZON_CONFIG

# Kolla-ansible defaults this to 'internalURL', which doesn't work when
# we need to access another region from across the public internet. Need
# to unfortunately default to 'public' interface for all endpoints as it is
# not currently possible (?) to use a different value here depending on which
# region is being used.
OPENSTACK_ENDPOINT_TYPE = 'publicURL'

# Default user to specific region on login.
DEFAULT_SERVICE_REGIONS = {
  '*': '{{ openstack_region_name }}',
}

# Used by server instance page to create links from the instance overview
# to the resource catalog.
CHAMELEON_PORTAL_API_BASE_URL = '{{ chameleon_portal_url }}'
CHAMELEON_REFERENCE_API_URL = '{{ chameleon_reference_api_url }}'
CHAMELEON_SITE_ID = '{{ chameleon_site_name }}'
{% if enable_chameleon_multisite | bool %}
# Hide the region dropdown
OPENSTACK_KEYSTONE_MULTIREGION_SUPPORT = False
# Show the site dropdown
CHAMELEON_MULTISITE_SUPPORT = True
{% else %}
CHAMELEON_SITES = {
{% for conf in horizon_regions %}
  '{{ conf.region_name }}': '{{ conf.chameleon_site_name }}',
{% endfor %}
}
{% endif %}

SITE_BRANDING = 'ChameleonCloud'

# Hide default Help link
HORIZON_CONFIG['help_url'] = None
{% if enable_zun | bool and not enable_nova | bool %}
# Special case when Zun is enabled and Nova is not; change default view from Nova to Zun
HORIZON_CONFIG['user_home'] = '/project/container/containers'
{% endif %}
# Add in extra links
USER_MENU_LINKS = [
{% if horizon_help_url %}
  {
    'name': _('Help Desk'),
    'icon_classes': ['fa-question-circle'],
    'url': '{{ horizon_help_url }}',
    'external': True,
  },
{% endif %}
{% if horizon_documentation_url %}
  {
    'name': _('Documentation'),
    'icon_classes': ['fa-book'],
    'url': '{{ horizon_documentation_url }}',
    'external': True,
  },
{% endif %}
  {
    'name': _('OpenStack RC File'),
    'icon_classes': ['fa-download'],
    'url': 'horizon:project:api_access:openrc',
    'external': False,
  },
]

{% if enable_blazar | bool %}
# Blazar-specific settings
{% if blazar_floatingip_reservation_network_regex is defined %}
OPENSTACK_BLAZAR_FLOATINGIP_RESERVATION = {
  # Allow reserving floating IPs on this network
  'enabled': True,
  'network_name_regex': '{{ blazar_floatingip_reservation_network_regex }}'
}
{% endif %}
OPENSTACK_BLAZAR_DEVICE_RESERVATION = {
  'enabled': {{ enable_zun | bool }},
}
OPENSTACK_BLAZAR_HOST_RESERVATION = {
  'enabled': {{ enable_nova | bool }},
}
# Used for Blazar dashboard, which needs to pull data from the MySQL database
# directly at the moment.
DATABASES = {
  'default': {},
{% for conf in horizon_regions %}
{% if conf.blazar_database_host is defined %}
  'blazar-{{ conf.region_name }}': {
    'ENGINE': 'django.db.backends.mysql',
    'NAME': '{{ conf.blazar_database_name }}',
    'HOST': '{{ conf.blazar_database_host }}',
    'PORT': '{{ conf.blazar_database_port }}',
    'USER': '{{ conf.blazar_database_user }}',
    'PASSWORD': '{{ conf.blazar_database_password }}',
  },
{% endif %}
{% endfor %}
}
{% endif %}

# Add Chameleon theme and the default theme (which it inherits from), but
# only allow the user to pick the Chameleon one.
chameleon_theme = (
  'chameleoncloud', 'ChameleonCloud',
  '/etc/openstack-dashboard/themes/chameleoncloud')
AVAILABLE_THEMES = [
  ('default', 'Default', 'themes/default'),
  chameleon_theme,
]
SELECTABLE_THEMES = [
  chameleon_theme,
]
# Not really needed, but suppresses a spurious warning.
DEFAULT_THEME = chameleon_theme[0]

# NOTE(jason): This is lifted from local_settings.j2 in Kolla-Ansible; we have
# to override it to add in a kludgy entry for Portal SSO, which isn't a "true"
# SSO in the same way as the others, which have e.g. Keystone mappings and
# assume an identity provider is registered in Keystone. We also remove the
# local login.
{% if enable_keystone_federation | bool %}
WEBSSO_ENABLED = True
WEBSSO_KEYSTONE_URL = "{{ keystone_public_url }}/v3"
WEBSSO_CHOICES = (
    ("portal", "Log in with TACC account (Legacy)"),
{% for idp in keystone_identity_providers %}
    ("{{ idp.name }}", "{{ idp.public_name }}"),
{% endfor %}
)
WEBSSO_IDP_MAPPING = {
    "portal": (None, None),
{% for idp in keystone_identity_providers %}
    "{{ idp.name }}": ("{{ idp.name }}", "{{ idp.protocol }}"),
{% endfor %}
}
WEBSSO_DEFAULT_REDIRECT = True
# This really shouldn't have to be set, but it's set at configuration parse
# time and derived from a value (OPENSTACK_KEYSTONE_URL) that is overriden by
# our configuration.
WEBSSO_DEFAULT_REDIRECT_REGION = '{{ keystone_public_url }}/v3'
WEBSSO_DEFAULT_REDIRECT_PROTOCOL = 'openid'
# Use mod_auth_openidc's built-in front channel logout support (part of the
# OpenID spec.) If we make a request to the `OIDCRedirectURI` with a ?logout
# parameter set to a valid redirect URI, the user's session will be cleared both
# within the mod_auth_openidc session cache, but also on the authenticating
# provider itself. We redirect to the custom post-logout page.
WEBSSO_DEFAULT_REDIRECT_LOGOUT = '{{ keystone_public_url }}/redirect_uri?logout={{ (identity_provider_url ~ "/post-logout?client_id=" ~ (keystone_idp_client_id|default(none)) ) | urlencode }}'

{% if enable_horizon_chameleon_websso | bool %}
AUTHENTICATION_URLS = ['openstack_dashboard.cc_web_sso_urls', 'openstack_auth.urls']
WEBSSO_DEFAULT_REDIRECT_URL = '{{ horizon_chameleon_websso_host }}/sso/horizon'
# Show users interstitial page upon logout instead of logging them out of Portal immediately
WEBSSO_DEFAULT_REDIRECT_LOGOUT_CONFIRM = True
WEBSSO_DEFAULT_REDIRECT_LOGOUT_CONFIRM_URL = '{{ horizon_chameleon_websso_host }}/logout'
{% endif %}
{% endif %}

# A dictionary of settings which can be used to provide the default values for
# properties found in the Launch Instance modal.
LAUNCH_INSTANCE_DEFAULTS = {
    'config_drive': False,
    'enable_scheduler_hints': True,
    'disable_image': False,
    'disable_instance_snapshot': True,
    'disable_volume': True,
    'disable_volume_snapshot': True,
    'create_volume': False,
}

# [2020-02-05 jason]
# TODO: solve the root problem here and re-enable this extension.
# Turn off SimpleTenantUsage extension, which has caused severe performance
# penalties in our version of Horizon. This makes the little table on the
# main dashboard page, which shows a list of recent instances, not show up.
# The API calls to Nova to populate this UI were going through an endless loop,
# clogging up server resources.
OPENSTACK_NOVA_EXTENSIONS_BLACKLIST = [
    'SimpleTenantUsage',
]

# The OPENSTACK_IMAGE_BACKEND settings can be used to customize features
# in the OpenStack Dashboard related to the Image service, such as the list
# of supported image formats.
OPENSTACK_IMAGE_BACKEND = {
    'image_formats': [
        ('qcow2', 'QCOW2 - QEMU Emulator'),
        ('raw', 'Raw'),
    ],
}

# The OPENSTACK_HEAT_STACK has the only setting available - enable_user_pass,
# which can be used to disable the password field while launching the stack.
# Set to False if HEAT uses trusts by default otherwise it needs to be set as True.
OPENSTACK_HEAT_STACK = {
    'enable_user_pass': False
}
